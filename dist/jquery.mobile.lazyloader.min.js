!function(e,t){"use strict";var r=e(t),i=e.mobile.filterable;i&&e.widget("mobile.filterable",i,{_filterItems:function(e){var t=this,r=t.element,i=r.data("mobile-lazyloader");if(i){if(i.option("searchQuery")!==e){var o=function(){r.off("lazyloaderdoneloading lazyloadererror",o),t._trigger("filter",null,{items:t._getFilterableItems()})};r.one("lazyloaderdoneloading lazyloadererror",o),i.option("searchQuery",e)}}else t._super(e)}}),e.widget("mobile.lazyloader",e.mobile.listview,{options:{url:"",$progress:"",templateId:""},defaults:{searchQuery:null,retrieved:0,retrieve:20,eventTimeout:100,postData:{},threshold:100,ajaxType:"POST"},_create:function(){this._done=!1,this.options=e.extend({},this.defaults,this.options),r.on("scrollstart scrollstop wheel",this._handleEventProxy=e.proxy(this._handleEvent,this)),this._super(),this.options.filter||this._load()},loadMore:function(e){this._load(e)},reset:function(e){this.options.retrieved=0,this._done=!1,this.element.empty(),this._load(e,!0)},_load:function(t,i){var o=this,s=o.options;o._done||(isNaN(t)&&(t=0),o._loadTimeout=setTimeout(function(){o.element.height()-s.threshold<=r.scrollTop()+r.height()?(e(s.$progress).show(),o._sendRequest(i)):(o._eventTriggered=!1,o._trigger("doneloading"))},t))},_sendRequest:function(t){var r=this,i=r.options,o=r.jqXHR;o&&o.abort(),o=e.ajax(i.url,{type:i.ajaxType,data:e.extend({},i.postData,{retrieved:i.retrieved,retrieve:i.retrieve,reset:!0===t,searchQuery:i.searchQuery}),dataType:"json"}),r.jqXHR=o,o.then(r._parseResponse.bind(r),function(e,t){"abort"!==t&&r._handleError(1,e)}).always(function(){r._eventTriggered=!1})},_parseResponse:function(t,i){if("abort"!==i){var o=this.options,s=t.items;if(Array.isArray(s)){var n=this.element,a=s.length,l=[],h=a<o.retrieve;o.retrieved+=a,ich.grabTemplates(),this._trigger("beforerender",{},[s]),s.forEach(function(e){l.push(ich[o.templateId](e))}),n.append(l),this.refresh();var d=n.height()>r.height();(d||h)&&e(o.$progress).hide(),this._done=h,h?(this._trigger("doneloading"),this._trigger("alldone")):d?this._trigger("doneloading"):this._load()}else this._handleError(2,t)}},_handleEvent:function(){!this._eventTriggered&&this.element.is(":visible")&&(this._eventTriggered=!0,this._load(this.options.eventTimeout))},_handleError:function(t,r){e(this.options.$progress).hide(),this._trigger("error",{},{errorCode:t,errorData:r})},_setOption:function(e,t){this._super(e,t),"searchQuery"===e&&this.reset()},destroy:function(){r.off("scrollstart scrollstop wheel",this._handleEventProxy),clearTimeout(this._loadTimeout),this._super()}})}(jQuery,window);