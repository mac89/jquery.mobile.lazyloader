!function(e,t){"use strict";var r=e(t),i=e.mobile.filterable;i&&e.widget("mobile.filterable",i,{_filterItems:function(e){var t=this,r=t.element,i=r.data("mobile-lazyloader");if(i){if(i.option("searchQuery")!==e){var o=function(){r.off("lazyloaderdoneloading lazyloadererror",o),t._trigger("filter",null,{items:t._getFilterableItems()})};r.one("lazyloaderdoneloading lazyloadererror",o),i.option("searchQuery",e)}}else t._super(e)}}),e.widget("mobile.lazyloader",e.mobile.listview,{options:{url:"",$progress:"",templateId:""},defaults:{searchQuery:null,retrieved:0,retrieve:20,eventTimeout:100,searchTimeout:300,postData:{},threshold:100,ajaxType:"POST",ajaxSettings:{type:"POST"},removeDuplicates:!0},_create:function(){this._done=!1,this._lastRequestTime=0,this.options=e.extend({},this.defaults,this.options),r.on("scrollstart scrollstop wheel",this._handleEventProxy=e.proxy(this._handleEvent,this)),this._super(),this.options.filter||this._load()},loadMore:function(e){this._load(e)},reset:function(e){this.options.retrieved=0,this._done=!1,this.element.empty(),this._blockEventRequest=!0,this._trigger("reset"),this._load(e,!0)},_load:function(t,r){var i=this,o=e.extend({},i.options);i._done||(isNaN(t)&&(t=0),clearTimeout(i._loadTimeout),i._loadTimeout=setTimeout(function(){var t=i.element;r||i._showHierarchy(function(){return t.height()+t.offset().top-o.threshold<i._getScrollParent().scrollTop()+i._getWindowHeight()})?(e(o.$progress).show(),i._sendRequest(e.extend({},o),r)):(i._blockEventRequest=!1,i._trigger("doneloading"))},t))},_sendRequest:function(t,r){var i=this,o=i.jqXHR;o&&o.abort();var s=Date.now();i._lastRequestTime=s,o=e.ajax(t.url,e.extend(!0,{},{type:t.ajaxType,data:t.postData},t.ajaxSettings,{data:{retrieved:t.retrieved,retrieve:t.retrieve,reset:!0===r,searchQuery:t.searchQuery},dataType:"json"})),i.jqXHR=o,o.then(function(e,t){i._parseResponse(e,t,s,r)},function(e,t){"abort"!==t&&i._handleError(1,e)}).always(function(){i._blockEventRequest=!1})},_parseResponse:function(e,t,r,i){if(!(r<this._lastRequestTime)){var o=this.options,s=e.items,n=this.element;if(i&&(o.retrieved=0,n.empty()),Array.isArray(s)){var l=s.length;this._trigger("beforerender",{},[s]),this._renderItems(s),this._finish(l)}else this._handleError(2,e)}},_renderItems:function(t){var r=this.options,i=this.element,o=[],s=i.children();ich.grabTemplates(),t.forEach(function(e){o.push(ich[r.templateId](e))}),i.append(o),r.removeDuplicates&&(this.refresh(),s.each(function(){if(0===o.length)return!1;var t=e(this);o.some(function(e,r){return e.clone().removeClass("ui-first-child ui-last-child").prop("outerHTML")===t.clone().removeClass("ui-first-child ui-last-child").prop("outerHTML")&&(o.splice(r,1),e.remove(),!0)})})),this.refresh(),r.retrieved+=o.length},_finish:function(t){var r=this,i=r.options,o=t<i.retrieve,s=r._showHierarchy(function(){var e=r._getScrollParent(),t=e.is(document)?r._getWindowHeight():e.height();return r.element.height()>t});(s||o)&&e(i.$progress).hide(),r._done=o,o?(r._trigger("doneloading"),r._trigger("alldone")):s?r._trigger("doneloading"):r._load()},_getScrollParent:function(){for(var e=this.element.scrollParent();e[0].scrollHeight<=e[0].clientHeight;)e=e.scrollParent();return e},_showHierarchy:function(t){var r=[];this.element.parentsUntil().each(function(){var t=e(this);"none"===t.css("display")&&(r.push({element:t,style:t.attr("style")}),t.show())});var i=t();return r.forEach(function(e){e.element.attr("style",e.style)}),i},_handleEvent:function(){!this._blockEventRequest&&this.element.is(":visible")&&(this._blockEventRequest=!0,this._load(this.options.eventTimeout))},_handleError:function(t,r){e(this.options.$progress).hide(),this._trigger("error",{},{errorCode:t,errorData:r})},_getWindowHeight:function(){return r.height()},_setOption:function(e,t){this._super(e,t),"searchQuery"===e&&this.reset(this.options.searchTimeout)},destroy:function(){r.off("scrollstart scrollstop wheel",this._handleEventProxy),clearTimeout(this._loadTimeout),this._super()}})}(jQuery,window);