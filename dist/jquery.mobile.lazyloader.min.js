!function(e,t){"use strict";var i=e(t),r=e.mobile.filterable;r&&e.widget("mobile.filterable",r,{_filterItems:function(e){var t=this,i=t.element,r=i.data("mobile-lazyloader");if(r){if(r.option("searchQuery")!==e){var o=function(){i.off("lazyloaderdoneloading lazyloadererror",o),t._trigger("filter",null,{items:t._getFilterableItems()})};i.one("lazyloaderdoneloading lazyloadererror",o),r.option("searchQuery",e)}}else t._super(e)}}),e.widget("mobile.lazyloader",e.mobile.listview,{options:{url:"",$progress:"",templateId:""},defaults:{searchQuery:null,retrieved:0,retrieve:20,eventTimeout:100,searchTimeout:300,postData:{},threshold:100,ajaxType:"POST",ajaxSettings:{type:"POST"}},_create:function(){this._done=!1,this._lastRequestTime=0,this.options=e.extend({},this.defaults,this.options),i.on("scrollstart scrollstop wheel",this._handleEventProxy=e.proxy(this._handleEvent,this)),this._super(),this.options.filter||this._load()},loadMore:function(e){this._load(e)},reset:function(e){this.options.retrieved=0,this._done=!1,this.element.empty(),this._blockEventRequest=!0,this._load(e,!0)},_load:function(t,i){var r=this,o=e.extend({},r.options);r._done||(isNaN(t)&&(t=0),clearTimeout(r._loadTimeout),r._loadTimeout=setTimeout(function(){var t=r.element;t.height()+t.offset().top-o.threshold<r._getScrollParent().scrollTop()+r._getWindowHeight()||i?(e(o.$progress).show(),r._sendRequest(e.extend({},o),i)):(r._blockEventRequest=!1,r._trigger("doneloading"))},t))},_sendRequest:function(t,i){var r=this,o=r.jqXHR;o&&o.abort();var s=Date.now();r._lastRequestTime=s,o=e.ajax(t.url,e.extend(!0,{},{type:t.ajaxType,data:t.postData},t.ajaxSettings,{data:{retrieved:t.retrieved,retrieve:t.retrieve,reset:!0===i,searchQuery:t.searchQuery},dataType:"json"})),r.jqXHR=o,o.then(function(e,t){r._parseResponse(e,t,s,i)},function(e,t){"abort"!==t&&r._handleError(1,e)}).always(function(){r._blockEventRequest=!1})},_parseResponse:function(t,i,r,o){if(!(r<this._lastRequestTime)){var s=this.options,n=t.items,a=this.element;if(o&&(s.retrieved=0,a.empty()),Array.isArray(n)){var l=n.length,h=[],d=l<s.retrieve;s.retrieved+=l,ich.grabTemplates(),this._trigger("beforerender",{},[n]),n.forEach(function(e){h.push(ich[s.templateId](e))}),a.append(h),this.refresh();var u=this._getScrollParent(),c=u.is(document)?this._getWindowHeight():u.height(),_=a.height()>c;(_||d)&&e(s.$progress).hide(),this._done=d,d?(this._trigger("doneloading"),this._trigger("alldone")):_?this._trigger("doneloading"):this._load()}else this._handleError(2,t)}},_getScrollParent:function(){for(var e=this.element.scrollParent();e[0].scrollHeight<=e[0].clientHeight;)e=e.scrollParent();return e},_handleEvent:function(){!this._blockEventRequest&&this.element.is(":visible")&&(this._blockEventRequest=!0,this._load(this.options.eventTimeout))},_handleError:function(t,i){e(this.options.$progress).hide(),this._trigger("error",{},{errorCode:t,errorData:i})},_getWindowHeight:function(){return i.height()},_setOption:function(e,t){this._super(e,t),"searchQuery"===e&&this.reset(this.options.searchTimeout)},destroy:function(){i.off("scrollstart scrollstop wheel",this._handleEventProxy),clearTimeout(this._loadTimeout),this._super()}})}(jQuery,window);